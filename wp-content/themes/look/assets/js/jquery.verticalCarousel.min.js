(function($) {
    $.fn.verticalCarousel = function(options) {

        var defaults = { nSlots: 2, speed: 300,nMargin:0 };
        var options = $.extend(defaults, options);
        var wSlotsht;
        var wSlotsht_scr;
        var nofs;
        var curfs = 1;
        var scrollDirection;
        var selector;

        return this.each(function() {
            selector = this.id;
            $("#" + selector + " a.scru").hide();
            $("#" + selector + " a.scrd").hide();
            if($("#" + selector + " div.vertical-carousel-container").find('li').length > options.nSlots)
            {
                $("#" + selector + " a.scru").show();
                $("#" + selector + " a.scrd").show();
                var margin = options.nMargin;
                if(margin == 0)
                {
                    margin = $("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list li").outerHeight(true) - $("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list li").outerHeight();

                }


                $("#" + selector + " div.vertical-carousel-container").height(($("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list li").outerHeight(true)  * options.nSlots) - margin ).css('overflow','hidden');
                $("#" + selector + " a.scru").click(function() {scrollDirection="up";calcspots(margin);});
                $("#" + selector + " a.scrd").click(function() {scrollDirection = "down";calcspots(margin);});
            }

        });

        function calcspots(margin)
        {
            if ($("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list").is(":animated")) {return;}
            wSlotsht = $("#" + selector + " div.vertical-carousel-container").height() + 10 + margin;
            wSlotsht_scr = $("#" + selector + " div.vertical-carousel-container").height();
            nofs = Math.ceil($("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list").height() / wSlotsht_scr);
            curtop = parseInt($("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list").css('top'));
            curfs = $("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list").height() - Math.abs(curtop);
            curfs = Math.ceil(curfs / (wSlotsht_scr+5));
            curfs = nofs - curfs + 1;

            if(curfs > 1 && scrollDirection == "up")
            {
                $("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list").animate({top: '+=' + wSlotsht}, options.speed, function() {});
                $("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list").animate({top: '-=10'}, options.speed + 100, function() {});
            }
            else if(curfs <= 1 && scrollDirection == "up")
            {
                $("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list").animate({top: '+=10'}, 100, function() {});
                $("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list").animate({top: '-=10'}, 200, function() {});
            }
            else if(curfs < nofs && scrollDirection == "down")
            {
                $("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list").animate({top: '-=' + wSlotsht}, options.speed, function() {});
                $("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list").animate({top: '+=10'}, options.speed + 100, function() {});
            }
            else if(scrollDirection == "down")
            {
                $("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list").animate({top: '-=10'}, 100, function() {});
                $("#" + selector + " div.vertical-carousel-container ul.vertical-carousel-list").animate({top: '+=10'}, 200, function() {});
            }
        }

    };
})(jQuery);